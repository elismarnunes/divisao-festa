<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Divis√£o de Gastos da Festa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#020617">

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #38bdf8;
      --danger: #ef4444;
    }

    body {
      margin: 0;
      font-family: system-ui;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 14px;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border-radius: 22px;
      padding: 16px;
    }

    h1, h2, h3 {
      text-align: center;
    }

    label {
      font-size: 13px;
      color: var(--muted);
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      border: none;
      margin-top: 6px;
      background: #020617;
      color: var(--text);
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 18px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      margin-top: 10px;
    }

    .danger {
      background: var(--danger);
    }

    .hidden {
      display: none;
    }

    .pessoa {
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 10px;
      margin-top: 10px;
    }

    .linha {
      display: grid;
      grid-template-columns: 2fr 60px 70px 44px;
      gap: 10px;
      align-items: end;
    }

    .resultado {
      white-space: pre-line;
      font-size: 14px;
      margin-top: 10px;
    }

    .infoFesta {
      margin-top: 10px;
      border: 1px solid #334155;
      border-radius: 14px;
      padding: 10px;
      text-align: center;
    }

    canvas {
      display: block;
      margin: 20px auto;
    }
  </style>
</head>

<body>

  <div class="card" id="app">
    <h1>üçæ Divis√£o de Gastos</h1>

    <button onclick="novaFesta()">‚ûï NOVA FESTA</button>

    <div id="infoFesta" class="infoFesta hidden">
      <b id="festaNome"></b><br>
      <span id="festaValor"></span>
    </div>

    <h3>Pessoas</h3>

    <div id="pessoas"></div>

    <button onclick="adicionarPessoa()">‚ûï Adicionar pessoa</button>
    <button onclick="calcular()">Calcular divis√£o</button>

    <div id="resultado" class="resultado"></div>
    <div id="resumo" class="resultado"></div>

    <button onclick="exportarPDF()">üìä PDF da Festa</button>
    <button onclick="abrirQR()">üî≥ QR Code / Compartilhar</button>
    <button onclick="abrirHistorico()">üìö Hist√≥rico</button>
  </div>

  <!-- TELA QR -->
  <div class="card hidden" id="telaQR">
    <button onclick="voltar()">‚¨Ö Voltar</button>
    <h2>QR Code da Festa</h2>
    <canvas id="qrcode"></canvas>
    <button onclick="compartilharWhatsapp()">üì§ WhatsApp</button>
  </div>

  <!-- HIST√ìRICO -->
  <div class="card hidden" id="telaHistorico">
    <button onclick="voltar()">‚¨Ö Voltar</button>
    <h2>üìö Hist√≥rico de Festas</h2>
    <div id="listaHistorico"></div>
    <button onclick="exportarHistoricoPDF()">üìä PDF Hist√≥rico</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const SITE = 'https://elismar09.github.io/divisao-festa/';
    const KEY = 'historico_festas';

    let festaAtual = null;
    let contador = 0;
    let ultimaDivisao = [];

    function normalizarValor(v) {
      if (!v) return NaN;
      return parseFloat(v.replace(/\./g, '').replace(',', '.'));
    }

    function novaFesta() {
      const nome = prompt('NOME DA FESTA');
      if (!nome) return;

      const v = prompt('VALOR TOTAL DA FESTA');
      const valor = normalizarValor(v);
      if (isNaN(valor)) return alert('Valor inv√°lido');

      festaAtual = {
        id: Date.now(),
        nome: nome.toUpperCase(),
        valor
      };

      contador = 0;
      pessoas.innerHTML = '';
      resultado.textContent = '';
      resumo.textContent = '';

      festaNome.innerText = festaAtual.nome;
      festaValor.innerText = 'Valor total: R$ ' + valor.toFixed(2);
      infoFesta.classList.remove('hidden');
    }

    function adicionarPessoa() {
      contador++;

      const d = document.createElement('div');
      d.className = 'pessoa';

      d.innerHTML = `
        <div class="linha">
          <div>
            <label>Pessoa ${contador}</label>
            <input class="nome" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div style="text-align:center">
            <label>Meia</label><br>
            <input type="checkbox" class="meia">
          </div>
          <div>
            <label>Dias</label>
            <input type="number" class="dias" min="1" value="1">
          </div>
          <button class="danger" onclick="if(confirm('Remover pessoa?')) this.closest('.pessoa').remove()">‚ùå</button>
        </div>
      `;

      pessoas.appendChild(d);
    }

    function calcular() {
      if (!festaAtual) return alert('Crie a festa');

      const dados = [...document.querySelectorAll('.pessoa')].map(p => ({
        nome: p.querySelector('.nome').value || 'SEM NOME',
        meia: p.querySelector('.meia').checked,
        dias: +p.querySelector('.dias').value,
        valor: 0
      }));

      if (!dados.length) return alert('Adicione pessoas');

      const u = dados.reduce((s, p) => s + p.dias * (p.meia ? 0.5 : 1), 0);
      const v = festaAtual.valor / u;

      dados.forEach(p => p.valor = p.dias * (p.meia ? 0.5 : 1) * v);
      dados[0].valor += festaAtual.valor - dados.reduce((s, p) => s + p.valor, 0);

      ultimaDivisao = dados;

      resultado.textContent = '';
      dados.forEach(p => {
        resultado.textContent += `- ${p.nome}: R$ ${p.valor.toFixed(2)}
`;
      });

      resumo.textContent = 'Total conferido ‚úîÔ∏è';
      salvarHistorico(dados);
    }

    function salvarHistorico(pessoas) {
      const h = JSON.parse(localStorage.getItem(KEY)) || [];
      h.push({
        id: festaAtual.id,
        festa: festaAtual.nome,
        data: new Date().toLocaleDateString(),
        total: festaAtual.valor,
        pessoas
      });
      localStorage.setItem(KEY, JSON.stringify(h));
    }

    function abrirQR() {
      if (!ultimaDivisao.length) return alert('Calcule antes');
      app.classList.add('hidden');
      telaQR.classList.remove('hidden');
      QRCode.toCanvas(qrcode, gerarLink());
    }

    function gerarLink() {
      return SITE + '?dados=' + btoa(JSON.stringify({
        festa: festaAtual.nome,
        total: festaAtual.valor,
        pessoas: ultimaDivisao
      }));
    }

    function compartilharWhatsapp() {
      window.open(
        'https://wa.me/?text=' + encodeURIComponent(gerarLink()),
        '_blank'
      );
    }

    function abrirHistorico() {
      app.classList.add('hidden');
      telaHistorico.classList.remove('hidden');

      const h = JSON.parse(localStorage.getItem(KEY)) || [];
      listaHistorico.innerHTML = '';

      h.forEach((f, i) => {
        listaHistorico.innerHTML += `
          <div class="pessoa">
            <b>${f.festa}</b><br>
            ${f.data} ‚Ä¢ R$ ${f.total.toFixed(2)}<br>
            <button class="danger" onclick="excluir(${i})">Excluir</button>
          </div>
        `;
      });
    }

    function excluir(i) {
      if (!confirm('Excluir festa?')) return;

      const h = JSON.parse(localStorage.getItem(KEY)) || [];
      h.splice(i, 1);
      localStorage.setItem(KEY, JSON.stringify(h));

      abrirHistorico();
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFillColor(2, 6, 23);
      pdf.rect(0, 0, 210, 25, 'F');

      pdf.setTextColor(255);
      pdf.setFontSize(18);
      pdf.text('Divis√£o de Gastos', 105, 17, { align: 'center' });

      pdf.setTextColor(0);
      let y = 40;

      pdf.text(festaAtual.nome, 105, y, { align: 'center' });
      y += 10;

      ultimaDivisao.forEach(p => {
        pdf.text(`${p.nome}: R$ ${p.valor.toFixed(2)}`, 20, y);
        y += 7;
      });

      pdf.save('festa.pdf');
    }

    function exportarHistoricoPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      let y = 20;
      pdf.text('Hist√≥rico de Festas', 105, y, { align: 'center' });
      y += 10;

      const h = JSON.parse(localStorage.getItem(KEY)) || [];
      h.forEach(f => {
        pdf.text(`${f.festa} - ${f.data} - R$ ${f.total.toFixed(2)}`, 20, y);
        y += 7;
      });

      pdf.save('historico.pdf');
    }

    function voltar() {
      location.reload();
    }
  </script>

</body>
</html>
