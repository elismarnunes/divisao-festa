<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DivisÃ£o de Gastos da Festa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#020617">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{--bg:#020617;--card:#020617;--text:#e5e7eb;--muted:#94a3b8;--primary:#38bdf8;--danger:#ef4444}
body.light{--bg:#f1f5f9;--card:#fff;--text:#020617;--muted:#475569;--primary:#2563eb;--danger:#dc2626}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:14px}
.card{width:100%;max-width:520px;background:var(--card);border-radius:22px;padding:16px}
h1,h2,h3{text-align:center}
label{font-size:13px;color:var(--muted)}
input{width:100%;padding:12px;border-radius:14px;border:none;margin-top:6px;background:#020617;color:var(--text)}
body.light input{background:#f1f5f9}
button{width:100%;padding:14px;border-radius:18px;border:none;background:var(--primary);color:#fff;font-weight:600;margin-top:10px}
.danger{background:var(--danger)}
.hidden{display:none}
.pessoa{border:1px solid #334155;border-radius:16px;padding:10px;margin-top:10px}
.linha{display:grid;grid-template-columns:2fr 60px 70px 44px;gap:10px;align-items:end}
.resultado{white-space:pre-line;font-size:14px;margin-top:10px}
.footer{margin-top:16px;border-top:1px solid #334155;padding-top:12px}
canvas{display:block;margin:20px auto}
</style>
</head>
<body>
<div class="card" id="app">
<h1>ğŸ¾ DivisÃ£o de Gastos</h1>
<button onclick="novaFesta()">â• NOVA FESTA</button>

<div id="dadosFesta" class="hidden">
<label>Nome da festa</label>
<input id="nomeFesta" oninput="this.value=this.value.toUpperCase()">
<label>Valor total da festa (R$)</label>
<input id="valorTotal" type="number" step="0.01">
</div>

<h3>Pessoas</h3>
<div id="pessoas"></div>
<button onclick="adicionarPessoa()">â• Adicionar pessoa</button>
<button onclick="calcular()">Calcular divisÃ£o</button>
<div id="resultado" class="resultado"></div>
<div id="resumo" class="resultado"></div>
<button onclick="exportarPDF()">ğŸ“„ Exportar PDF</button>

<div class="footer">
<button onclick="abrirQR()">ğŸ”³ QR Code / Compartilhar</button>
<button onclick="abrirHistorico()">ğŸ“š HistÃ³rico</button>
<button onclick="toggleTema()">ğŸŒ— Tema</button>
</div>
</div>

<!-- QR -->
<div class="card hidden" id="telaQR">
<button onclick="voltar()">â¬… Voltar</button>
<h2>QR Code da Festa</h2>
<canvas id="qrcode"></canvas>
<button onclick="compartilharWhatsapp()">ğŸ“¤ WhatsApp</button>
</div>

<!-- HISTÃ“RICO -->
<div class="card hidden" id="telaHistorico">
<button onclick="voltar()">â¬… Voltar</button>
<h2>ğŸ“š HistÃ³rico</h2>
<div id="listaHistorico"></div>
<h3>ğŸ† Ranking acumulado</h3>
<div id="ranking"></div>
<button onclick="exportarHistoricoPDF()">ğŸ“Š PDF RelatÃ³rio Geral</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const SITE='https://elismar09.github.io/divisao-festa/';
const KEY='historico_festas';
let contador=0, ultimaDivisao=[];

// IMPORTAR VIA LINK
window.onload=()=>{
 const p=new URLSearchParams(location.search);
 if(p.has('dados')){
  try{
   const d=JSON.parse(atob(p.get('dados')));
   novaFesta();
   nomeFesta.value=d.festa;
   valorTotal.value=d.total;
   d.pessoas.forEach(p=>{
    adicionarPessoa();
    const el=pessoas.lastChild;
    el.querySelector('.nome').value=p.nome;
    el.querySelector('.meia').checked=p.meia;
    el.querySelector('.dias').value=p.dias;
   });
   calcular();
  }catch(e){alert('Link invÃ¡lido');}
 }
};

function novaFesta(){dadosFesta.classList.remove('hidden');pessoas.innerHTML='';contador=0;resultado.textContent='';resumo.textContent='';}

function adicionarPessoa(){
 contador++;
 const d=document.createElement('div');d.className='pessoa';
 d.innerHTML=`<div class="linha">
 <div><label>Pessoa ${contador}</label><input class="nome" oninput="this.value=this.value.toUpperCase()"></div>
 <div style="text-align:center"><label>Meia</label><br><input type="checkbox" class="meia"></div>
 <div><label>Dias</label><input type="number" class="dias" min="1" value="1"></div>
 <button class="danger" onclick="this.closest('.pessoa').remove()">âŒ</button>
 </div>`;
 pessoas.appendChild(d);
}

function calcular(){
 const total=parseFloat(valorTotal.value); if(isNaN(total))return alert('Valor invÃ¡lido');
 const dados=[...document.querySelectorAll('.pessoa')].map(p=>({
  nome:p.querySelector('.nome').value||'SEM NOME',
  meia:p.querySelector('.meia').checked,
  dias:+p.querySelector('.dias').value,valor:0
 }));
 const u=dados.reduce((s,p)=>s+p.dias*(p.meia?0.5:1),0);
 const v=total/u;
 dados.forEach(p=>p.valor=p.dias*(p.meia?0.5:1)*v);
 dados[0].valor+=total-dados.reduce((s,p)=>s+p.valor,0);
 dados.sort((a,b)=>b.dias-a.dias||a.nome.localeCompare(b.nome));
 resultado.textContent='';dados.forEach(p=>resultado.textContent+=`- ${p.nome}: R$ ${p.valor.toFixed(2)} (${p.dias} dia${p.meia?', meia':''})\n`);
 resumo.textContent=`Total: R$ ${total.toFixed(2)} âœ”ï¸ OK`;
 ultimaDivisao=dados;
 salvarHistorico(dados,total);
}

function salvarHistorico(p,t){const h=JSON.parse(localStorage.getItem(KEY))||[];h.push({data:new Date().toLocaleDateString(),festa:nomeFesta.value,total:t,pessoas:p});localStorage.setItem(KEY,JSON.stringify(h));}

function abrirQR(){app.classList.add('hidden');telaQR.classList.remove('hidden');QRCode.toCanvas(qrcode, gerarLink());}
function gerarLink(){return SITE+'?dados='+btoa(JSON.stringify({festa:nomeFesta.value,total:valorTotal.value,pessoas:ultimaDivisao}));}
function compartilharWhatsapp(){window.open(`https://wa.me/?text=${encodeURIComponent('DivisÃ£o da festa '+gerarLink())}`,'_blank');}

function abrirHistorico(){app.classList.add('hidden');telaHistorico.classList.remove('hidden');const h=JSON.parse(localStorage.getItem(KEY))||[];listaHistorico.innerHTML='';ranking.innerHTML='';const r={};h.forEach(f=>{listaHistorico.innerHTML+=`<div class='pessoa'><b>${f.festa}</b><br>${f.data} â€¢ R$ ${f.total.toFixed(2)}</div>`;f.pessoas.forEach(p=>r[p.nome]=(r[p.nome]||0)+p.valor);});Object.entries(r).sort((a,b)=>b[1]-a[1]).forEach(([n,v])=>ranking.innerHTML+=`<div class='pessoa'>${n} â€” R$ ${v.toFixed(2)}</div>`);}

function exportarPDF(){const {jsPDF}=window.jspdf;const pdf=new jsPDF();pdf.setFillColor(2,6,23);pdf.rect(0,0,210,20,'F');pdf.setTextColor(255);pdf.setFontSize(16);pdf.text('DivisÃ£o de Gastos',105,14,{align:'center'});pdf.setTextColor(0);let y=30;pdf.text(nomeFesta.value,105,y,{align:'center'});y+=10;pdf.text(resumo.textContent,15,y);y+=10;ultimaDivisao.forEach(p=>{pdf.text(`${p.nome} - R$ ${p.valor.toFixed(2)}`,15,y);y+=6});pdf.save('divisao_festa.pdf');}

function exportarHistoricoPDF(){const {jsPDF}=window.jspdf;const pdf=new jsPDF();let y=15;pdf.text('RelatÃ³rio Geral de Festas',105,y,{align:'center'});y+=10;const h=JSON.parse(localStorage.getItem(KEY))||[];h.forEach(f=>{pdf.text(`${f.festa} - ${f.data} - R$ ${f.total.toFixed(2)}`,15,y);y+=7});pdf.save('relatorio_festas.pdf');}

function voltar(){location.href=SITE}
function toggleTema(){document.body.classList.toggle('light')}
</script>
</body>
</html>